services:
  frontend:
    build:
      context: ./public
      dockerfile: Dockerfile.frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      - backend
    networks:
      - app-network
    dns:
      - 8.8.8.8
      - 8.8.4.4

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${APP_PORT:-3001}:3000"
    volumes:
      - ./src:/app/src
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    networks:
      - app-network
    dns:
      - 8.8.8.8
      - 8.8.4.4

  mongodb:
    image: mongo:6
    restart: unless-stopped
    profiles: ["db"]
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-localuser}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-localpass}
    volumes:
      - mongo_data:/data/db
    networks:
      - app-network

  nagios:
    image: jasonrivers/nagios:latest
    container_name: nagios
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${NAGIOS_HTTP_PORT:-8081}:80"
    environment:
      - NAGIOSADMIN_USER=${NAGIOSADMIN_USER:-nagiosadmin}
      - NAGIOSADMIN_PASS=${NAGIOSADMIN_PASS:-nagiosadmin}
    volumes:
      - ./monitoring/nagios/objects/online_local_mart.cfg:/opt/nagios/etc/conf.d/online_local_mart.cfg:ro
      - ./monitoring/nagios/objects/online_local_mart_commands.cfg:/opt/nagios/etc/conf.d/online_local_mart_commands.cfg:ro
      - ./monitoring/nagios/plugins:/opt/nagios/libexec/custom:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-network

  ansible:
    image: williamyeh/ansible:alpine3
    container_name: ansible
    working_dir: /ansible
    volumes:
      - ./ansible:/ansible
    tty: true
    stdin_open: true
    command: tail -f /dev/null
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mongo_data:
