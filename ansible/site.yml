---
# Ansible playbook to deploy Online Local Mart (Dockerized)
# Runs directly inside the Ansible container (localhost)

- name: Deploy Online Local Mart
  hosts: localhost
  connection: local
  gather_facts: false
  become: false

  vars:
    project_src: "/ansible/.."               # Path to main project (mounted from host)
    app_state: "started"                     # started | stopped | restarted | present | absent
    with_db: false                           # Enable Compose 'db' profile if true
    pull_images: true                        # Pull latest images before (re)create

  tasks:
    - name: Ensure community.docker collection is installed
      shell: ansible-galaxy collection install community.docker
      args:
        warn: false
      changed_when: false

    - name: Create default .env file if missing
      copy:
        dest: "{{ project_src }}/.env"
        content: |
          APP_PORT=3000
          FRONTEND_PORT=80
          NODE_ENV=production
          MONGODB_PORT=27017
          MONGO_INITDB_ROOT_USERNAME=localuser
          MONGO_INITDB_ROOT_PASSWORD=localpass
          NAGIOSADMIN_USER=nagiosadmin
          NAGIOSADMIN_PASS=nagiosadmin
        force: no
        mode: "0640"

    - name: Deploy stack with Docker Compose v2
      shell: |
        cd {{ project_src }}
        docker compose {{ (with_db | bool) | ternary('--profile db ', '') }} up -d
      args:
        executable: /bin/sh

    - name: Show running containers
      shell: docker ps
      register: ps_output

    - debug:
        var: ps_output.stdout_lines
